import logging
import os
from telegram import Update, WebAppInfo, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', 
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ù–ê–°–¢–†–û–ô–ö–ò –ë–û–¢–ê
# –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω –æ—Ç BotFather
BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"

# URL –≤–∞—à–µ–≥–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è 
# –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ ngrok: "https://abc123.ngrok.io"
# –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —á–µ—Ä–µ–∑ Render: "https://your-app-name.onrender.com"
WEB_APP_URL = "YOUR_WEB_APP_URL_HERE"

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–æ–π Mini App"""
    
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É —Å Web App
    web_app = WebAppInfo(url=WEB_APP_URL)
    keyboard = [
        [KeyboardButton("üß† –û—Ç–∫—Ä—ã—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É", web_app=web_app)],
        [KeyboardButton("‚ÑπÔ∏è –ü–æ–º–æ—â—å"), KeyboardButton("üìä –û –±–æ—Ç–µ")]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    user_name = update.effective_user.first_name
    welcome_text = f"""
üéâ *–ü—Ä–∏–≤–µ—Ç, {user_name}! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —É–º–Ω—É—é –≤–∏–∫—Ç–æ—Ä–∏–Ω—É!*

üß† *–ß—Ç–æ –≤–∞—Å –∂–¥–µ—Ç:*
‚Ä¢ üìö –ò—Å—Ç–æ—Ä–∏—è - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–Ω–∞–Ω–∏—è –ø—Ä–æ—à–ª–æ–≥–æ
‚Ä¢ üî¨ –ù–∞—É–∫–∞ - —Ä–∞–∑–≥–∞–¥–∞–π—Ç–µ —Ç–∞–π–Ω—ã –ø—Ä–∏—Ä–æ–¥—ã  
‚Ä¢ üåç –û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è - –ø–æ–∫–∞–∂–∏—Ç–µ —ç—Ä—É–¥–∏—Ü–∏—é

‚ú® *–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:*
‚Ä¢ –ö—Ä–∞—Å–∏–≤—ã–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚Ä¢ –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤
‚Ä¢ –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤ —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

üéØ *–ì–æ—Ç–æ–≤—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è?*
–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É!
"""
    
    await update.message.reply_text(
        welcome_text,
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /help - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –ø–æ–º–æ—â—å"""
    
    help_text = """
üÜò *–ü–æ–¥—Ä–æ–±–Ω–∞—è –ø–æ–º–æ—â—å –ø–æ –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ*

üéÆ *–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:*
1Ô∏è‚É£ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É 'üß† –û—Ç–∫—Ä—ã—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É'
2Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–∑ —Ç—Ä–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
3Ô∏è‚É£ –û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –Ω–∞–∂–∏–º–∞—è –Ω–∞ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
4Ô∏è‚É£ –°–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
5Ô∏è‚É£ –ü–æ–ª—É—á–∏—Ç–µ —Ñ–∏–Ω–∞–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É –≤ –∫–æ–Ω—Ü–µ

üèÜ *–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:*
‚Ä¢ üèõ *–ò—Å—Ç–æ—Ä–∏—è* - —Å–æ–±—ã—Ç–∏—è –ø—Ä–æ—à–ª–æ–≥–æ, –≤–µ–ª–∏–∫–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏, –¥–∞—Ç—ã
‚Ä¢ üî¨ *–ù–∞—É–∫–∞* - —Ñ–∏–∑–∏–∫–∞, —Ö–∏–º–∏—è, –±–∏–æ–ª–æ–≥–∏—è, –æ—Ç–∫—Ä—ã—Ç–∏—è
‚Ä¢ üåç *–û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è* - –≥–µ–æ–≥—Ä–∞—Ñ–∏—è, —Å–ø–æ—Ä—Ç, –∫—É–ª—å—Ç—É—Ä–∞

üìä *–°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–æ–∫:*
‚Ä¢ üèÜ 80-100% = –û—Ç–ª–∏—á–Ω–æ! –í—ã —ç—Ä—É–¥–∏—Ç!
‚Ä¢ ü•â 60-79% = –•–æ—Ä–æ—à–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!
‚Ä¢ üìö 40-59% = –ù–µ–ø–ª–æ—Ö–æ! –ï—Å—Ç—å –∫ —á–µ–º—É —Å—Ç—Ä–µ–º–∏—Ç—å—Å—è!
‚Ä¢ üí™ 0-39% = –ù–µ —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ—Å—å, —É—á–∏—Ç–µ—Å—å –¥–∞–ª—å—à–µ!

üéØ *–ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã:*
‚Ä¢ –ß–∏—Ç–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ
‚Ä¢ –ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ—Å—å —Å –æ—Ç–≤–µ—Ç–æ–º
‚Ä¢ –ò–∑—É—á–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
‚Ä¢ –ò–≥—Ä–∞–π—Ç–µ –≤ —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö
‚Ä¢ –°–æ—Ä–µ–≤–Ω—É–π—Ç–µ—Å—å —Å –¥—Ä—É–∑—å—è–º–∏!

üîÑ *–ú–æ–∂–µ—Ç–µ –∏–≥—Ä–∞—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ —Ä–∞–∑ –∏ —É–ª—É—á—à–∞—Ç—å —Å–≤–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!*
"""
    
    await update.message.reply_text(help_text, parse_mode='Markdown')

async def about_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ"""
    
    about_text = """
ü§ñ *–û –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ*

üì± *–≠—Ç–æ Telegram Mini App* - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä—è–º–æ –≤ Telegram –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º.

üë®‚Äçüíª *–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:*
‚Ä¢ Python + Flask (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å)
‚Ä¢ HTML5 + CSS3 + JavaScript (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
‚Ä¢ SQLite (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–∫–æ—Ä–¥–æ–≤)
‚Ä¢ Telegram Bot API + Mini Apps

üéØ *–¶–µ–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞:*
‚Ä¢ –û–±—É—á–µ–Ω–∏–µ –∏ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ
‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ —ç—Ä—É–¥–∏—Ü–∏–∏
‚Ä¢ –ò–∑—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤
‚Ä¢ –°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ —Å –¥—Ä—É–∑—å—è–º–∏

üìà *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:*
‚Ä¢ –í–∞—à–∏ –ª—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
‚Ä¢ –û–±—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤
‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∏–≥—Ä

üöÄ *–ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ:*
–ú—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ —É–ª—É—á—à–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å!

üí¨ *–ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è?*
–ü–∏—à–∏—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É —á–µ—Ä–µ–∑ /help
"""
    
    await update.message.reply_text(about_text, parse_mode='Markdown')

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    
    text = update.message.text.lower()
    
    if "–ø–æ–º–æ—â—å" in text or text == "‚ÑπÔ∏è –ø–æ–º–æ—â—å":
        await help_command(update, context)
    elif "–æ –±–æ—Ç–µ" in text or text == "üìä –æ –±–æ—Ç–µ":
        await about_command(update, context)
    elif "–≤–∏–∫—Ç–æ—Ä–∏–Ω" in text or "–∏–≥—Ä" in text:
        await update.message.reply_text(
            "üéÆ –î–ª—è –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É 'üß† –û—Ç–∫—Ä—ã—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É' –≤ –º–µ–Ω—é!"
        )
    elif "–ø—Ä–∏–≤–µ—Ç" in text or "hello" in text:
        await update.message.reply_text(
            f"üëã –ü—Ä–∏–≤–µ—Ç, {update.effective_user.first_name}! "
            "–ì–æ—Ç–æ–≤—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è? –ù–∞–∂–º–∏—Ç–µ 'üß† –û—Ç–∫—Ä—ã—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É'!"
        )
    else:
        await update.message.reply_text(
            "ü§î –ù–µ –ø–æ–Ω—è–ª –∫–æ–º–∞–Ω–¥—É. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n"
            "‚Ä¢ /start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
            "‚Ä¢ /help - –ø–æ–º–æ—â—å\n"
            "‚Ä¢ 'üß† –û—Ç–∫—Ä—ã—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É' - –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É"
        )

async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫"""
    logger.warning(f'Update {update} caused error {context.error}')

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    if BOT_TOKEN == "YOUR_BOT_TOKEN_HERE":
        print("‚ùå –û–®–ò–ë–ö–ê: –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–º–µ–Ω–∏—Ç—å YOUR_BOT_TOKEN_HERE –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω –æ—Ç BotFather!")
        return
    
    if WEB_APP_URL == "YOUR_WEB_APP_URL_HERE":
        print("‚ùå –û–®–ò–ë–ö–ê: –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–º–µ–Ω–∏—Ç—å YOUR_WEB_APP_URL_HERE –Ω–∞ URL –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!")
        return
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    application = Application.builder().token(BOT_TOKEN).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("about", about_command))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    application.add_error_handler(error_handler)
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    print(f"üåê Web App URL: {WEB_APP_URL}")
    print("üì± Mini App –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    print("‚ú® –ù–∞–π–¥–∏—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start")
    
    # –ó–∞–ø—É—Å–∫ polling
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()

